/*
	Copyright 2015 Norut Northern Research Institute
	Author : Ingar MÃ¦hlum Arntzen

  This file is part of the Sequencer module.

  The Sequencer is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  The Sequencer is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with the Sequencer.  If not, see <http://www.gnu.org/licenses/>.
*/

define("/sequencer",["./timeoututils","./interval","./axis"],function(e,t,n){"use strict";var r=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return function(n){n=n||e;var r="";for(var i=0;i<n;i++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}}(10),i=function(){return(new Date).getTime()/1e3},s=0,o=1,u=2,a=3,f=function(e){return!isNaN(parseFloat(e))},l=function(e,t){t===undefined&&(t=clock());var n=t-e[a],r=e[o]+e[u]*n,i=e[s]+e[o]*n+.5*e[u]*n*n;return[i,r,e[u],t]},c=function(e){return e===null?!1:e[o]!==0||e[u]!==0?!0:!1},h=function(e,t){if(e>t)return 1;if(e===t)return 0;if(e<t)return-1},p=function(e,t){var n=l(e,t),r=h(n[o],0);return r===0&&(r=h(e[u],0)),r},d=function(e,t,n,r){return Math.pow(t,2)-2*n*(e-r)>=0?!0:!1},v=function(e,t,n,r){if(n===0&&t===0)return e!=r?[]:[0];if(n===0)return[(r-e)/t];if(d(e,t,n,r)===!1)return[];var i=t*t-2*n*(e-r);if(i===0)return[-t/n];var s=Math.sqrt(Math.pow(t,2)-2*n*(e-r)),o=(-t+s)/n,u=(-t-s)/n;return[Math.min(o,u),Math.max(o,u)]},m=function(e,t,n,r){var i=v(e,t,n,r);return i.length===0?[]:i.length==1?i[0]>0?[i[0]]:[]:i.length==2?i[1]<0?[]:i[0]>0?[i[0],i[1]]:i[1]>0?[i[1]]:[]:[]},g=function(e,t,n,r){var i=m(e,t,n,r);return i.length===0?null:i[0]},y=function(e,t){var n=e[s],r=e[o],i=e[u],a=g(n,r,i,t.low),f=g(n,r,i,t.high);return a!==null&&f!==null?a<f?[a,t.low]:[f,t.high]:a!==null?[a,t.low]:f!==null?[f,t.high]:[null,null]},b=function(e,t,n){var r=function(e,t){return e[0]-t[0]},i=[],a=e[s],f=e[o],l=e[u];for(var c=0;c<n.length;c++){var h=n[c],p=v(a,f,l,h.point);for(var d=0;d<p.length;d++){var m=p[d];0<=m&&m<=t&&i.push([m,h])}}return i.sort(r),i},w=function(e,n){var r=e[s],i=e[o],a=e[u],f=r+i*n+.5*a*n*n;if(a!==0){var l=-i/a;if(0<=l&&l<=n){var c=r-.5*i*i/a;return a>0?new t(c,Math.max(r,f),!0,!0):new t(Math.min(r,f),c,!0,!0)}}return new t(Math.min(r,f),Math.max(r,f),!0,!0)},E=function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=!1;for(var s=0;s<t.length;s++)if(e[r]===t[s]){i=!0;break}i||n.push(e[r])}return n},S=Object.freeze({ENTER:"enter",EXIT:"exit",toString:function(e){if(e===S.ENTER)return"enter";if(e===S.EXIT)return"exit";throw new C("illegal string value verb type "+e)},fromInteger:function(e){if(e===-1)return S.EXIT;if(e===1)return S.ENTER;throw new C("illegal integer value for direction type "+e)}}),x=Object.freeze({BACKWARDS:"backwards",FORWARDS:"forwards",NODIRECTION:"nodirection",toInteger:function(e){if(e===x.BACKWARDS)return-1;if(e===x.FORWARDS)return 1;if(e===x.NODIRECTION)return 0;throw new C("illegal string value direction type "+string)},fromInteger:function(e){if(e===0)return x.NODIRECTION;if(e===-1)return x.BACKWARDS;if(e===1)return x.FORWARDS;throw new C("illegal integer value for direction type"+e+" "+typeof e)}}),T=function(e){this.queue=[],this.options=e||{},this.options.lookahead=this.options.lookahead||5;var n=i();this.timeInterval=new t(n,n+this.options.lookahead,!0,!0),this.posInterval=null};T.prototype.getTimeInterval=function(){return this.timeInterval},T.prototype.getPosInterval=function(){return this.posInterval},T.prototype.setPosInterval=function(e){this.posInterval=e},T.prototype.sortFunc=function(e,t){return e.ts-t.ts},T.prototype.push=function(e,t,n){if(this.timeInterval.coversPoint(t)){var r={ts:t,task:n,push_ts:e};if(t>=e)return this.queue.push(r),this.queue.sort(this.sortFunc),!0;console.log("Schedule : task pushed a bit too late, ts < now ",t-e)}return!1},T.prototype.pop=function(e){var t=[];while(this.queue.length>0&&this.queue[0].ts<=e){var n=this.queue.shift(),r={task:n.task,pop_ts:e,push_ts:n.push_ts,ts:n.ts};t.push(r)}return t},T.prototype.invalidate=function(e){var t,n,r,i=[];for(t=0;t<this.queue.length;t++)r=this.queue[t],r.task.key===e&&i.push(r);for(t=0;t<i.length;t++)r=i[t],n=this.queue.indexOf(r),n>-1&&this.queue.splice(n,1)},T.prototype.advance=function(e){e<this.timeInterval.low&&console.log("Schedule : Advancing backwards "+(e-this.timeInterval.low)),this.queue=[],this.timeInterval=new t(e,e+this.options.lookahead,!1,!0),this.posInterval=null},T.prototype.isExpired=function(e){return e>this.timeInterval.high},T.prototype.getDelayNextTs=function(e){return this.queue.length>0?Math.max(0,this.queue[0].ts-e):Math.max(0,this.timeInterval.high-e)};var N=function(e){this._argOrder=[],this._argMap={},this._sequencer=e};N.prototype.addCue=function(e,t,n){return this._argOrder.push(e),this._argMap[e]={key:e,interval:t,data:n},this},N.prototype.removeCue=function(e,t){return this.addCue(e,undefined,t)},N.prototype.submit=function(){var e=[];return this._argOrder.forEach(function(t){e.push(this._argMap[t])},this),this._argMap={},this._argOrder=[],e.length>0?this._sequencer.updateAll(e):[]};var C=function(e){this.name="SequencerError",this.message=e||""};C.prototype=Error.prototype;var k=function(e,t,n,r,i,s,o,u,a,f){this.src=e,this.key=t,this.interval=n,this.point=i,this.pointType=s,this.dueTs=u,this.delay=o-u,this.directionType=a,this.verbType=f,this.data=r};k.prototype.toString=function(){var e="["+this.point.toFixed(2)+"]";return e+=" "+this.key,e+=" "+this.interval.toString(),e+=" "+this.verbType,e+=" "+this.directionType,e+=" "+this.pointType,e+=" delay:"+this.delay.toFixed(4),this.data&&(e+=" "+JSON.stringify(this.data)),e};var L=function(e,t,n){this.key=e,this.interval=t,this.data=n};L.prototype.toString=function(){var e=this.key+" "+this.interval.toString();return this.data&&(e+=" "+JSON.stringify(this.data)),e};var A=function(e){this._motion=e,this._axis=new n.Axis,this._schedule=null,this._to=null,this._activeKeys=[],this._callbacks={events:[],enter:[],exit:[],change:[],changes:[]},this.ID=r(4),this._motion.on("change",this._onMotionUpdate,this),this.loadData()};A.prototype.loadData=function(){},A.prototype.getData=function(e){},A.prototype._onMotionUpdate=function(e){var r=i(),o=this._motion.getInfo().vector;this._schedule===null?this._schedule=new T:(r=o[a],this._schedule.advance(r));var u=l(o,r),f=this._activeKeys,h=this._axis.lookupByPoint(u[s]).map(function(e){return e.key}),d=E(f,h),v=E(h,f),m=c(o);if(m){var g=u[s],y=this._axis.lookupByInterval(new t(g,g,!0,!0));y.forEach(function(e){if(e.pointType===n.PointType.SINGULAR)d.push(e.key);else{var t=e.interval,i=!1;e.pointType===n.PointType.LOW&&t.lowInclude?i=!0:e.pointType===n.PointType.HIGH&&t.highInclude&&(i=!0);var s=p(o,r),u=!0;e.pointType===n.PointType.LOW&&s===x.BACKWARDS&&(u=!1),e.pointType===n.PointType.HIGH&&s===x.FORWARDS&&(u=!1),!u&&i&&d.push(e.key),u&&!i&&v.push(e.key)}},this)}var b=d.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this),w=v.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this);this._processIntervalEvents(r,b,w),this._load(r),this._main(r)},A.prototype.updateAll=function(e){if(this._motion.readyState===this._motion.STATE.CLOSED)throw new C("Update failed: Msv closed");var t,r,o,u,a,f=this._axis.updateAll(e),h=f.filter(function(e){return e.type!==n.OpType.NOOP});if(this._motion.readyState===this._motion.STATE.INIT)return f;var p=i(),d=l(this._motion.getInfo().vector,p),v=d[s],m=[],g=[],y,b;h.forEach(function(e){u=e.interval,o=e.key,y=this.isActive(o),b=!1,(e.type===n.OpType.CREATE||e.type===n.OpType.UPDATE)&&u.coversPoint(v)&&(b=!0),e.type===n.OpType.REMOVE?a=e.data:a=e.data||this.getData(o),y&&!b?g.push({key:o,interval:u,data:a}):!y&&b&&m.push({key:o,interval:u,data:a})},this);var w=f.filter(function(e){return this.isActive(e.key)&&m.indexOf(e.key)===-1},this).map(function(e){return{key:e.key,interval:e.interval,data:e.data}},this);if(this._schedule===null)return;var E=c(d);if(!E)this._schedule.advance(p);else{h.forEach(function(e){this._schedule.invalidate(e.key)},this);var S,x=[];h.forEach(function(e){u=e.interval,o=e.key;if(e.type===n.OpType.REMOVE)return;if(E){var t={key:o,interval:u},r=this._schedule.getPosInterval();r!==null&&(r.coversPoint(u.low)&&(t.point=u.low),r.coversPoint(u.high)&&(t.point=u.high),t.pointType=this._axis.getPointType(t.point,t.interval),x.push(t))}},this),x.length>0&&this._load(p,x)}var T=this;setTimeout(function(){T._processIntervalEvents(p,g,m),T._processChangeEvents(p,w),T._main(p)},0)},A.prototype._main=function(t){this._to!==null&&(this._to.cancel(),this._to=null),t=t||i(),this._processScheduleEvents(t,this._schedule.pop(t));var n=c(this._motion.getInfo().vector);n&&this._schedule.isExpired(t)&&(t=this._schedule.getTimeInterval().high,this._schedule.advance(t),this._load(t),this._processScheduleEvents(t,this._schedule.pop(t)));if(n){var r=i(),s=this._schedule.getDelayNextTs(r),o=this;this._to=new e(function(){o._main()},s*1e3,{anchor:r*1e3,early:.5})}},A.prototype._load=function(e,r){var i=c(this._motion.getInfo().vector);if(!i)return;var s=this._schedule.getTimeInterval(),u=s.low,a=s.high,h=a-u,p=this._motion.getInfo().vector,d=this._motion.getInfo().range,v=f(d[0])?d[0]:-Infinity,m=f(d[1])?d[1]:Infinity,g=new t(v,m,!0,!0),E=l(p,u),S=r;if(!S){var x=w(E,h),T=Math.max(x.low,g.low),N=Math.min(x.high,g.high);x=new t(T,N,!0,!0),this._schedule.setPosInterval(x),S=this._axis.lookupByInterval(x)}S.forEach(function(e){e.data=this.getData(e.key)},this);var C=b(E,h,S),k=y(E,g)[0];C.forEach(function(t){var r=t[0],i=t[1],s=!0;r===0&&(s=!1),r>k&&(s=!1),r===k&&(s=!1);if(i.pointType===n.PointType.LOW||i.pointType===n.PointType.HIGH){var a=l(this._motion.getInfo().vector,u+r);a[o]===0&&(s=!1)}s&&this._schedule.push(e,u+r,i)},this)},A.prototype._makeEArgs=function(e,t,r,i,s,o,u,a){var f=x.fromInteger(i),l=this._axis.getPointType(o,t);if(s===undefined){var c=n.PointType.toInteger(l),h=c*i*-1;s=S.fromInteger(h)}return new k(this,e,t,r,o,l,u,a,f,s)},A.prototype._processScheduleEvents=function(e,t){var n,r=[],s=l(this._motion.getInfo().vector,e),o=p(s,e),u=i();t.forEach(function(e){e.task.interval.isSingular()?(n=this._makeEArgs(e.task.key,e.task.interval,e.task.data,o,S.ENTER,e.task.point,u,e.ts),r.push(n),n=this._makeEArgs(e.task.key,e.task.interval,e.task.data,o,S.EXIT,e.task.point,u,e.ts),r.push(n)):(n=this._makeEArgs(e.task.key,e.task.interval,e.task.data,o,undefined,e.task.point,u,e.ts),r.push(n))},this),r&&this._notifyCallback(e,r)},A.prototype._processIntervalEvents=function(e,t,n,r){if(t.length+n.length===0)return;var o=l(this._motion.getInfo().vector,e),u=p(o,e),a=i(),f=[];t.forEach(function(t){f.push(this._makeEArgs(t.key,t.interval,t.data,u,S.EXIT,o[s],a,e))},this),n.forEach(function(t){f.push(this._makeEArgs(t.key,t.interval,t.data,u,S.ENTER,o[s],a,e))},this),this._notifyCallback(e,f,r)},A.prototype._processChangeEvents=function(e,t){this._doCallbacks("changes",t),t.forEach(function(e){this._doCallbacks("change",e)},this)},A.prototype._initHandler=function(e){if(this._motion.readyState!==this._motion.STATE.INIT){var t=i();if(this._activeKeys.length>0){var n=this._activeKeys.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this);return this._processIntervalEvents(t,[],n,e),!0}}return!1},A.prototype._notifyCallback=function(e,t,n){var r,i=[];t.forEach(function(e){if(e.verbType===S.EXIT){r=this._activeKeys.indexOf(e.key);if(r>-1)this._activeKeys.splice(r,1);else if(n===undefined)return}if(e.verbType===S.ENTER){r=this._activeKeys.indexOf(e.key);if(r===-1)this._activeKeys.push(e.key);else if(n===undefined)return}i.push(e)},this),i.length>0&&(i=this._reorderEventList(i),this._doCallbacks("events",i,n),i.forEach(function(e){e.verbType===S.ENTER?this._doCallbacks("enter",e,n):e.verbType===S.EXIT&&this._doCallbacks("exit",e,n)},this))},A.prototype._doCallbacks=function(e,t,n){var r;this._callbacks[e].forEach(function(r){if(n===undefined){if(r["_immediatePending_"+e+this.ID])return}else{if(r!==n)return;n["_immediatePending_"+e+this.ID]=!1}try{r.call(r["_ctx_"+e+this.ID],t)}catch(i){console.log("Error in "+e+": "+r+": "+i)}},this)},A.prototype._reorderEventList=function(e){if(e.length<2)return e;var t,r,i=[],s={a:[],x:[],b:[],c:[],y:[],d:[]};return e.forEach(function(e){if(e.point!==t||e.dueTs!==r)i=i.concat(s.a).concat(s.x).concat(s.b).concat(s.c).concat(s.y).concat(s.d),s={a:[],x:[],b:[],c:[],y:[],d:[]},t=e.point,r=e.dueTs;if(e.pointType===n.PointType.SINGULAR)e.verbType===S.ENTER?s.b.push(e):s.c.push(e);else{var o=!1;e.pointType===n.PointType.LOW&&e.interval.lowInclude?o=!0:e.pointType===n.PointType.HIGH&&e.interval.highInclude&&(o=!0),e.verbType===S.ENTER?o?s.x.push(e):s.d.push(e):o?s.y.push(e):s.a.push(e)}},this),i.concat(s.a).concat(s.x).concat(s.b).concat(s.c).concat(s.y).concat(s.d)},A.prototype.on=function(e,t,n){if(!t||typeof t!="function")throw new C("Illegal handler");if(!this._callbacks.hasOwnProperty(e))throw new C("Unsupported event "+e);if(this._motion.readyState===this._motion.STATE.CLOSED)throw new C("Msv closed");var r=this._callbacks[e].indexOf(t);if(r===-1){t["_ctx_"+e+this.ID]=n||this,this._callbacks[e].push(t);if(e==="events"||e==="enter"){t["_immediatePending_"+e+this.ID]=!0;var i=this;setTimeout(function(){var n=i._initHandler(t);n||(t["_immediatePending_"+e+this.ID]=!1)},0)}}return this},A.prototype.off=function(e,t){if(this._callbacks[e]!==undefined){var n=this._callbacks[e].indexOf(t);n>-1&&this._callbacks[e].splice(n,1)}return this},A.prototype.request=function(){return new N(this)},A.prototype.addCue=function(e,t,n){return this.updateAll([{key:e,interval:t,data:n}])},A.prototype.removeCue=function(e,t){return this.updateAll([{key:e,interval:undefined,data:t}])},A.prototype.hasCue=function(e){return this._axis.hasKey(e)},A.prototype.keys=function(){return this._axis.keys()},A.prototype.getCue=function(e){if(this._axis.hasKey(e))return new L(e,this._axis.getIntervalByKey(e),this.getData(e))},A.prototype.getCues=function(){return this.keys().map(function(e){return this.getCue(e)},this)},A.prototype.isActive=function(e){return this._activeKeys.indexOf(e)>-1},A.prototype.getActiveKeys=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(t)},this),e},A.prototype.getActiveCues=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(this.getCue(t))},this),e},A.prototype.getCuesByPoint=function(e){return this._axis.lookupByPoint(e).map(function(e){return this.getCue(e.key)},this)},A.prototype.getCuesByInterval=function(e){var t={};return this._axis.lookupByInterval(e).forEach(function(e){t[e.key]=e.interval}),Object.keys(t).map(function(e){return this.getCue(e)},this).filter(function(t){return e.coversInterval(t.interval)},this)},A.prototype.getCuesCoveredByInterval=function(e){return this.getCuesByInterval(e).filter(function(t){return e.overlapsInterval(t.interval)?!0:!1},this)},A.prototype.close=function(){this._motion.off("change",this._onMotionUpdate),this.to!==null&&(this.to.cancel(),this.to=null)};var O=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e};return{inherit:O,Interval:t,Sequencer:A,SequencerError:C}}),define("sequencer/sequencer",function(){});