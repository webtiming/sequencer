/*
	Copyright 2015 Norut Northern Research Institute
	Author : Ingar Mæhlum Arntzen

  This file is part of the Sequencer module.

  The Sequencer is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  The Sequencer is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with the Sequencer.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
    Copyright 2015 Norut Northern Research Institute
    Author : Ingar Mæhlum Arntzen

  This file is part of the Sequencer module.

  The Sequencer is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation, either version 3 of the License, or
  (at your option) any later version.

  The Sequencer is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with the Sequencer.  If not, see <http://www.gnu.org/licenses/>.
*/

define("timeoututils",[],function(){"use strict";var e=function(){return(new Date).getTime()},t=function(t,n,r){this.tid=null,this.callback=t,this.delay_counter=0,this.options=r||{};var i=e();this.options.anchor=this.options.anchor||i,this.options.early=Math.abs(this.options.early)||0,this.target=this.options.anchor+n;var s=this;window.addEventListener("message",this,!0);var o=this.target-e();o>1e4?this.tid=setTimeout(function(){s._ontimeout()},o-3e3):this.tid=setTimeout(function(){s._ontimeout()},o-s.options.early)};return t.prototype._ontimeout=function(){if(this.tid!==null){var t=this.target-e();if(t<=0)this.cancel(),this.callback();else if(t>this.options.early){var n=this;this.tid=setTimeout(function(){n._ontimeout()},t-this.options.early)}else this._smalldelay()}},t.prototype.handleEvent=function(e){if(e.source===window&&e.data.indexOf("smalldelaymsg_")===0){e.stopPropagation();var t=parseInt(e.data.split("_")[1]);this.tid!==null&&this.tid===t&&this._ontimeout()}},t.prototype._smalldelay=function(){this.delay_counter++;var e=this;window.postMessage("smalldelaymsg_"+e.tid,"*")},t.prototype.cancel=function(){if(this.tid!==null){clearTimeout(this.tid),this.tid=null;var e=this;window.removeEventListener("message",this,!0)}},t}),define("interval",[],function(){"use strict";var e=function(e){var t=parseFloat(e);return e===t&&!isNaN(t)},t=function(e){this.name="IntervalError",this.message=e||""};t.prototype=Error.prototype;var n=function(n,r,i,s){var o=e(n),u=e(r);o&&r===undefined&&(r=n);if(!e(n))throw new t("low not a number");if(!e(r))throw new t("high not a number");if(n>r)throw new t("low > high");n===r&&(i=!0,s=!0),n===-Infinity&&(i=!0),r===Infinity&&(s=!0),i===undefined&&(i=!0),s===undefined&&(s=!1);if(typeof i!="boolean")throw new t("lowInclude not boolean");if(typeof s!="boolean")throw new t("highInclude not boolean");this.__defineGetter__("length",function(){return r-n}),this.__defineGetter__("low",function(){return n}),this.__defineGetter__("high",function(){return r}),this.__defineGetter__("lowInclude",function(){return i}),this.__defineGetter__("highInclude",function(){return s})};return n.prototype.toString=function(){var e=this.lowInclude?"[":"<",t=this.highInclude?"]":">",n=this.low===-Infinity?"<--":this.low.toFixed(2),r=this.high===Infinity?"-->":this.high.toFixed(2);return this.isSingular()?e+n+t:e+n+","+r+t},n.prototype.isFinite=function(){return isFinite(this.low)&&isFinite(this.high)},n.prototype.isSingular=function(){return this.low===this.high},n.prototype.coversPoint=function(e){return this.low<e&&e<this.high?!0:this.lowInclude&&e===this.low?!0:this.highInclude&&e===this.high?!0:!1},n.prototype.overlapsInterval=function(e){if(e instanceof n==0)throw new t("paramenter not instance of Interval");return this.isSingular()&&e.isSingular()?this.low===e.low:this.isSingular()?e.coversPoint(this.low):e.isSingular()?this.coversPoint(e.low):this.high<e.low?!1:this.high===e.low?this.coversPoint(e.low)&&e.coversPoint(this.high):this.low>e.high?!1:this.low===e.high?this.coversPoint(e.high)&&e.coversPoint(this.low):!0},n.prototype.coversInterval=function(e){if(e instanceof n==0)throw new t("paramenter not instance of Interval");return e.low<this.low||this.high<e.high?!1:this.low<e.low&&e.high<this.high?!0:this.low===e.low&&this.lowInclude===!1&&e.lowInclude===!0?!1:this.high===e.high&&this.highInclude===!1&&e.highInclude===!0?!1:!0},n.prototype.equals=function(e){return this.low!==e.low?!1:this.high!==e.high?!1:this.lowInclude!==e.lowInclude?!1:this.highInclude!==e.highInclude?!1:!0},n}),define("sortedarraybinary",["interval"],function(e){"use strict";var t=function(e){var t=parseFloat(e);return e==t&&!isNaN(t)},n=function(e){this.name="SortedArrayError",this.message=e||""};n.prototype=Error.prototype;var r=function(){this.array=[]};return r.prototype.binaryIndexOf=function(e){var t=0,n=this.array.length-1,r,i;while(t<=n){r=(t+n)/2|0,i=this.array[r];if(i<e)t=r+1;else{if(!(i>e))return r;n=r-1}}return~n},r.prototype.insert=function(e){var t=this.binaryIndexOf(e);(t<0||t===0&&this.array[0]!==e)&&this.array.splice(Math.abs(t),0,e)},r.prototype.indexOf=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?-1:t},r.prototype.hasElement=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?!1:!0},r.prototype.remove=function(e){var t=this.binaryIndexOf(e);if(t<0||t===0&&this.array[0]!==e)return;this.array.splice(t,1)},r.prototype.getMinimum=function(){return this.array.length>0?this.array[0]:null},r.prototype.getMaximum=function(){return this.array.length>0?this.array[this.array.length-1]:null},r.prototype.ltIndexOf=function(e){var t=this.binaryIndexOf(e);return t=t<0?Math.abs(t)-1:t-1,t>=0?t:-1},r.prototype.leIndexOf=function(e){var t=this.binaryIndexOf(e);return t>0||t===0&&this.array[0]===e?t:(t=Math.abs(t)-1,t>=0?t:-1)},r.prototype.gtIndexOf=function(e){var t=this.binaryIndexOf(e);return t===0?this.array[0]===e&&(t=1):t=t<0?Math.abs(t):t+1,t<this.array.length?t:-1},r.prototype.geIndexOf=function(e){var t=this.binaryIndexOf(e);return t>0||t===0&&this.array[0]===e?t:(t=Math.abs(t),t<this.array.length?t:-1)},r.prototype.indexOf=function(e){var t=this.binaryIndexOf(e);return t<0||t===0&&this.array[0]!==e?-1:t},r.prototype.lookup=function(t){t===undefined&&(t=new e(-Infinity,Infinity,!0,!0));if(t instanceof e==0)throw new n("lookup requires Interval argument");var r=-1,i=-1;return t.lowInclude?r=this.geIndexOf(t.low):r=this.gtIndexOf(t.low),r===-1?[]:(t.highInclude?i=this.leIndexOf(t.high):i=this.ltIndexOf(t.high),i===-1?[]:this.array.slice(r,i+1))},r.prototype.get=function(e){return this.array[e]},r.prototype.list=function(){return this.array},r}),define("multimap",[],function(){"use strict";var e=function(){this._map={}};return e.prototype.insert=function(e,t){return this.insertAll([{key:e,value:t}])},e.prototype.insertAll=function(e){var t,n=[];return e.forEach(function(e){this._map.hasOwnProperty(e.key)||(this._map[e.key]=[]),t=this._map[e.key],t.indexOf(e.value)===-1&&(t.push(e.value),n.push(e))},this),n},e.prototype.remove=function(e,t){return this.removeAll([{key:e,value:t}])},e.prototype.removeAll=function(e){var t,n,r=[];return e.forEach(function(e){this._map.hasOwnProperty(e.key)&&(n=this._map[e.key],t=n.indexOf(e.value),t>-1&&(n.splice(t,1),r.push(e),n.length===0&&delete this._map[e.key]))},this),r},e.prototype.hasKey=function(e){return this._map.hasOwnProperty(e)},e.prototype.keys=function(){return Object.keys(this._map)},e.prototype.getItemsByKey=function(e){var t=[];return this.hasKey(e)&&this._map[e].forEach(function(n){t.push({key:e,value:n})}),t},e.prototype.getItemsByKeys=function(e){e===undefined&&(e=this.keys());var t=[];return e.forEach(function(e){t=t.concat(this.getItemsByKey(e))},this),t},e.prototype.list=e.prototype.getItemsByKeys,e}),define("axis",["interval","sortedarraybinary","multimap"],function(e,t,n){"use strict";var r=function(e){this.name="AxisError",this.message=e||""};r.prototype=Error.prototype;var i=Object.freeze({NOOP:"noop",CREATE:"create",UPDATE:"update",REMOVE:"remove"}),s=Object.freeze({LOW:"low",SINGULAR:"singular",HIGH:"high",INSIDE:"inside",OUTSIDE:"outside",toInteger:function(e){if(e===s.LOW)return-1;if(e===s.HIGH)return 1;if(e===s.INSIDE)return 2;if(e===s.OUTSIDE)return 3;if(e===s.SINGULAR)return 0;throw new r("illegal string value for point type")},fromInteger:function(e){if(e===-1)return s.LOW;if(e===0)return s.SINGULAR;if(e===1)return s.HIGH;if(e===2)return s.INSIDE;if(e===3)return s.OUTSIDE;throw new r("illegal integer value for point type")}}),o=function(){this._map={},this._reverse=new n,this._index=new t};return o.prototype._insert=function(e,t){this._map[e]=t,this._reverse.hasKey(t.low)||this._index.insert(t.low),this._reverse.hasKey(t.high)||this._index.insert(t.high),this._reverse.insert(t.low,e),this._reverse.insert(t.high,e)},o.prototype._remove=function(e){if(!this._map.hasOwnProperty(e))throw new r("attempt to remove non-existing key");var t=this._map[e];return delete this._map[e],this._reverse.remove(t.low,e),this._reverse.remove(t.high,e),this._reverse.hasKey(t.low)||this._index.remove(t.low),this._reverse.hasKey(t.high)||this._index.remove(t.high),t},o.prototype.updateAll=function(t){var n,s=[],o,u,a;return t.forEach(function(t){u=t.key,a=t.interval;if(a===undefined)this._map.hasOwnProperty(u)?(o=this._remove(u),n={type:i.REMOVE,key:u,interval:o,data:t.data}):n={type:i.NOOP,key:u,interval:undefined,data:undefined};else{if(a instanceof e==0)throw new r("parameter must be instanceof Interval");this._map.hasOwnProperty(u)?(o=this._map[u],a.equals(o)?n={type:i.NOOP,key:u,interval:o,data:t.data}:(this._remove(u),this._insert(u,a),n={type:i.UPDATE,key:u,interval:a,data:t.data})):(this._insert(u,a),n={type:i.CREATE,key:u,interval:a,data:t.data})}s.push(n)},this),s},o.prototype.update=function(e,t){return this.updateAll([{key:e,interval:t}])},o.prototype.lookupByPoint=function(e){var t,n=[];return Object.keys(this._map).forEach(function(r){t=this._map[r],(e===undefined||t.coversPoint(e))&&n.push({key:r,interval:t})},this),n},o.prototype.lookupByInterval=function(e){var t=this._index.lookup(e),n=[],r,i;return this._index.lookup(e).forEach(function(t){this._reverse.getItemsByKey(t).forEach(function(r){t=r.key,e=this._map[r.value],n.push({key:r.value,interval:e,point:t,pointType:this.getPointType(t,e)})},this)},this),n},o.prototype.items=function(){return this.lookupByPoint()},o.prototype.keys=function(){return Object.keys(this._map)},o.prototype.getPointType=function(e,t){return t.isSingular()&&e===t.low?s.SINGULAR:e===t.low?s.LOW:e===t.high?s.HIGH:t.low<e&&e<t.high?s.INSIDE:s.OUTSIDE},o.prototype.getIntervalByKey=function(e){return this._map[e]},o.prototype.hasKey=function(e){return this._map.hasOwnProperty(e)},{Axis:o,OpType:i,PointType:s}}),define("sequencer",["timeoututils","interval","axis"],function(e,t,n){"use strict";var r=function(e){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return function(n){n=n||e;var r="";for(var i=0;i<n;i++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}}(10),i=function(){return(new Date).getTime()/1e3},s=0,o=1,u=2,a=3,f=function(e){return!isNaN(parseFloat(e))},l=function(e,t){t===undefined&&(t=clock());var n=t-e[a],r=e[o]+e[u]*n,i=e[s]+e[o]*n+.5*e[u]*n*n;return[i,r,e[u],t]},c=function(e){return e===null?!1:e[o]!==0||e[u]!==0?!0:!1},h=function(e,t){if(e>t)return 1;if(e===t)return 0;if(e<t)return-1},p=function(e,t){var n=l(e,t),r=h(n[o],0);return r===0&&(r=h(e[u],0)),r},d=function(e,t,n,r){return Math.pow(t,2)-2*n*(e-r)>=0?!0:!1},v=function(e,t,n,r){if(n===0&&t===0)return e!=r?[]:[0];if(n===0)return[(r-e)/t];if(d(e,t,n,r)===!1)return[];var i=t*t-2*n*(e-r);if(i===0)return[-t/n];var s=Math.sqrt(Math.pow(t,2)-2*n*(e-r)),o=(-t+s)/n,u=(-t-s)/n;return[Math.min(o,u),Math.max(o,u)]},m=function(e,t,n,r){var i=v(e,t,n,r);return i.length===0?[]:i.length==1?i[0]>0?[i[0]]:[]:i.length==2?i[1]<0?[]:i[0]>0?[i[0],i[1]]:i[1]>0?[i[1]]:[]:[]},g=function(e,t,n,r){var i=m(e,t,n,r);return i.length===0?null:i[0]},y=function(e,t){var n=e[s],r=e[o],i=e[u],a=g(n,r,i,t.low),f=g(n,r,i,t.high);return a!==null&&f!==null?a<f?[a,t.low]:[f,t.high]:a!==null?[a,t.low]:f!==null?[f,t.high]:[null,null]},b=function(e,t,n){var r=function(e,t){return e[0]-t[0]},i=[],a=e[s],f=e[o],l=e[u];for(var c=0;c<n.length;c++){var h=n[c],p=v(a,f,l,h.point);for(var d=0;d<p.length;d++){var m=p[d];0<=m&&m<=t&&i.push([m,h])}}return i.sort(r),i},w=function(e,n){var r=e[s],i=e[o],a=e[u],f=r+i*n+.5*a*n*n;if(a!==0){var l=-i/a;if(0<=l&&l<=n){var c=r-.5*i*i/a;return a>0?new t(c,Math.max(r,f),!0,!0):new t(Math.min(r,f),c,!0,!0)}}return new t(Math.min(r,f),Math.max(r,f),!0,!0)},E=function(e,t){var n=[];for(var r=0;r<e.length;r++){var i=!1;for(var s=0;s<t.length;s++)if(e[r]===t[s]){i=!0;break}i||n.push(e[r])}return n},S=Object.freeze({ENTER:"enter",EXIT:"exit",toString:function(e){if(e===S.ENTER)return"enter";if(e===S.EXIT)return"exit";throw new C("illegal string value verb type "+e)},fromInteger:function(e){if(e===-1)return S.EXIT;if(e===1)return S.ENTER;throw new C("illegal integer value for direction type "+e)}}),x=Object.freeze({BACKWARDS:"backwards",FORWARDS:"forwards",NODIRECTION:"nodirection",toInteger:function(e){if(e===x.BACKWARDS)return-1;if(e===x.FORWARDS)return 1;if(e===x.NODIRECTION)return 0;throw new C("illegal string value direction type "+string)},fromInteger:function(e){if(e===0)return x.NODIRECTION;if(e===-1)return x.BACKWARDS;if(e===1)return x.FORWARDS;throw new C("illegal integer value for direction type"+e+" "+typeof e)}}),T=function(e){this.queue=[],this.options=e||{},this.options.lookahead=this.options.lookahead||5;var n=i();this.timeInterval=new t(n,n+this.options.lookahead,!0,!0),this.posInterval=null};T.prototype.getTimeInterval=function(){return this.timeInterval},T.prototype.getPosInterval=function(){return this.posInterval},T.prototype.setPosInterval=function(e){this.posInterval=e},T.prototype.sortFunc=function(e,t){return e.ts-t.ts},T.prototype.push=function(e,t,n){if(this.timeInterval.coversPoint(t)){var r={ts:t,task:n,push_ts:e};if(t>=e)return this.queue.push(r),this.queue.sort(this.sortFunc),!0;console.log("Schedule : task pushed a bit too late, ts < now ",t-e)}return!1},T.prototype.pop=function(e){var t=[];while(this.queue.length>0&&this.queue[0].ts<=e){var n=this.queue.shift(),r={task:n.task,pop_ts:e,push_ts:n.push_ts,ts:n.ts};t.push(r)}return t},T.prototype.invalidate=function(e){var t,n,r,i=[];for(t=0;t<this.queue.length;t++)r=this.queue[t],r.task.key===e&&i.push(r);for(t=0;t<i.length;t++)r=i[t],n=this.queue.indexOf(r),n>-1&&this.queue.splice(n,1)},T.prototype.advance=function(e){e<this.timeInterval.low&&console.log("Schedule : Advancing backwards "+(e-this.timeInterval.low)),this.queue=[],this.timeInterval=new t(e,e+this.options.lookahead,!1,!0),this.posInterval=null},T.prototype.isExpired=function(e){return e>this.timeInterval.high},T.prototype.getDelayNextTs=function(e){return this.queue.length>0?Math.max(0,this.queue[0].ts-e):Math.max(0,this.timeInterval.high-e)};var N=function(e){this._argOrder=[],this._argMap={},this._sequencer=e};N.prototype.addCue=function(e,t,n){return this._argOrder.push(e),this._argMap[e]={key:e,interval:t,data:n},this},N.prototype.removeCue=function(e,t){return this.addCue(e,undefined,t)},N.prototype.submit=function(){var e=[];return this._argOrder.forEach(function(t){e.push(this._argMap[t])},this),this._argMap={},this._argOrder=[],e.length>0?this._sequencer.updateAll(e):[]};var C=function(e){this.name="SequencerError",this.message=e||""};C.prototype=Error.prototype;var k=function(e,t,n,r,i,s,o,u,a,f){this.src=e,this.key=t,this.interval=n,this.point=i,this.pointType=s,this.dueTs=u,this.delay=o-u,this.directionType=a,this.verbType=f,this.data=r};k.prototype.toString=function(){var e="["+this.point.toFixed(2)+"]";return e+=" "+this.key,e+=" "+this.interval.toString(),e+=" "+this.verbType,e+=" "+this.directionType,e+=" "+this.pointType,e+=" delay:"+this.delay.toFixed(4),this.data&&(e+=" "+JSON.stringify(this.data)),e};var L=function(e,t,n){this.key=e,this.interval=t,this.data=n};L.prototype.toString=function(){var e=this.key+" "+this.interval.toString();return this.data&&(e+=" "+JSON.stringify(this.data)),e};var A=function(e){this._motion=e,this._axis=new n.Axis,this._schedule=null,this._to=null,this._activeKeys=[],this._callbacks={events:[],enter:[],exit:[],change:[],changes:[]},this.ID=r(4),this._motion.on("change",this._onMotionUpdate,this),this.loadData()};A.prototype.loadData=function(){},A.prototype.getData=function(e){},A.prototype._onMotionUpdate=function(e){var r=i(),o=this._motion.getInfo().vector;this._schedule===null?this._schedule=new T:(r=o[a],this._schedule.advance(r));var u=l(o,r),f=this._activeKeys,h=this._axis.lookupByPoint(u[s]).map(function(e){return e.key}),d=E(f,h),v=E(h,f),m=c(o);if(m){var g=u[s],y=this._axis.lookupByInterval(new t(g,g,!0,!0));y.forEach(function(e){if(e.pointType===n.PointType.SINGULAR)d.push(e.key);else{var t=e.interval,i=!1;e.pointType===n.PointType.LOW&&t.lowInclude?i=!0:e.pointType===n.PointType.HIGH&&t.highInclude&&(i=!0);var s=p(o,r),u=!0;e.pointType===n.PointType.LOW&&s===x.BACKWARDS&&(u=!1),e.pointType===n.PointType.HIGH&&s===x.FORWARDS&&(u=!1),!u&&i&&d.push(e.key),u&&!i&&v.push(e.key)}},this)}var b=d.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this),w=v.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this);this._processIntervalEvents(r,b,w),this._load(r),this._main(r)},A.prototype.updateAll=function(e){if(this._motion.readyState===this._motion.STATE.CLOSED)throw new C("Update failed: Msv closed");var t,r,o,u,a,f=this._axis.updateAll(e),h=f.filter(function(e){return e.type!==n.OpType.NOOP});if(this._motion.readyState===this._motion.STATE.INIT)return f;var p=i(),d=l(this._motion.getInfo().vector,p),v=d[s],m=[],g=[],y,b;h.forEach(function(e){u=e.interval,o=e.key,y=this.isActive(o),b=!1,(e.type===n.OpType.CREATE||e.type===n.OpType.UPDATE)&&u.coversPoint(v)&&(b=!0),e.type===n.OpType.REMOVE?a=e.data:a=e.data||this.getData(o),y&&!b?g.push({key:o,interval:u,data:a}):!y&&b&&m.push({key:o,interval:u,data:a})},this);var w=f.filter(function(e){return this.isActive(e.key)&&m.indexOf(e.key)===-1},this).map(function(e){return{key:e.key,interval:e.interval,data:e.data}},this);if(this._schedule===null)return;var E=c(d);if(!E)this._schedule.advance(p);else{h.forEach(function(e){this._schedule.invalidate(e.key)},this);var S,x=[];h.forEach(function(e){u=e.interval,o=e.key;if(e.type===n.OpType.REMOVE)return;if(E){var t={key:o,interval:u},r=this._schedule.getPosInterval();r!==null&&(r.coversPoint(u.low)&&(t.point=u.low),r.coversPoint(u.high)&&(t.point=u.high),t.pointType=this._axis.getPointType(t.point,t.interval),x.push(t))}},this),x.length>0&&this._load(p,x)}var T=this;setTimeout(function(){T._processIntervalEvents(p,g,m),T._processChangeEvents(p,w),T._main(p)},0)},A.prototype._main=function(t){this._to!==null&&(this._to.cancel(),this._to=null),t=t||i(),this._processScheduleEvents(t,this._schedule.pop(t));var n=c(this._motion.getInfo().vector);n&&this._schedule.isExpired(t)&&(t=this._schedule.getTimeInterval().high,this._schedule.advance(t),this._load(t),this._processScheduleEvents(t,this._schedule.pop(t)));if(n){var r=i(),s=this._schedule.getDelayNextTs(r),o=this;this._to=new e(function(){o._main()},s*1e3,{anchor:r*1e3,early:.5})}},A.prototype._load=function(e,r){var i=c(this._motion.getInfo().vector);if(!i)return;var s=this._schedule.getTimeInterval(),u=s.low,a=s.high,h=a-u,p=this._motion.getInfo().vector,d=this._motion.getInfo().range,v=f(d[0])?d[0]:-Infinity,m=f(d[1])?d[1]:Infinity,g=new t(v,m,!0,!0),E=l(p,u),S=r;if(!S){var x=w(E,h),T=Math.max(x.low,g.low),N=Math.min(x.high,g.high);x=new t(T,N,!0,!0),this._schedule.setPosInterval(x),S=this._axis.lookupByInterval(x)}S.forEach(function(e){e.data=this.getData(e.key)},this);var C=b(E,h,S),k=y(E,g)[0];C.forEach(function(t){var r=t[0],i=t[1],s=!0;r===0&&(s=!1),r>k&&(s=!1),r===k&&(s=!1);if(i.pointType===n.PointType.LOW||i.pointType===n.PointType.HIGH){var a=l(this._motion.getInfo().vector,u+r);a[o]===0&&(s=!1)}s&&this._schedule.push(e,u+r,i)},this)},A.prototype._makeEArgs=function(e,t,r,i,s,o,u,a){var f=x.fromInteger(i),l=this._axis.getPointType(o,t);if(s===undefined){var c=n.PointType.toInteger(l),h=c*i*-1;s=S.fromInteger(h)}return new k(this,e,t,r,o,l,u,a,f,s)},A.prototype._processScheduleEvents=function(e,t){var n,r=[],s=l(this._motion.getInfo().vector,e),o=p(s,e),u=i();t.forEach(function(e){e.task.interval.isSingular()?(n=this._makeEArgs(e.task.key,e.task.interval,e.task.data,o,S.ENTER,e.task.point,u,e.ts),r.push(n),n=this._makeEArgs(e.task.key,e.task.interval,e.task.data,o,S.EXIT,e.task.point,u,e.ts),r.push(n)):(n=this._makeEArgs(e.task.key,e.task.interval,e.task.data,o,undefined,e.task.point,u,e.ts),r.push(n))},this),r&&this._notifyCallback(e,r)},A.prototype._processIntervalEvents=function(e,t,n,r){if(t.length+n.length===0)return;var o=l(this._motion.getInfo().vector,e),u=p(o,e),a=i(),f=[];t.forEach(function(t){f.push(this._makeEArgs(t.key,t.interval,t.data,u,S.EXIT,o[s],a,e))},this),n.forEach(function(t){f.push(this._makeEArgs(t.key,t.interval,t.data,u,S.ENTER,o[s],a,e))},this),this._notifyCallback(e,f,r)},A.prototype._processChangeEvents=function(e,t){this._doCallbacks("changes",t),t.forEach(function(e){this._doCallbacks("change",e)},this)},A.prototype._initHandler=function(e){if(this._motion.readyState!==this._motion.STATE.INIT){var t=i();if(this._activeKeys.length>0){var n=this._activeKeys.map(function(e){return{key:e,interval:this._axis.getIntervalByKey(e),data:this.getData(e)}},this);return this._processIntervalEvents(t,[],n,e),!0}}return!1},A.prototype._notifyCallback=function(e,t,n){var r,i=[];t.forEach(function(e){if(e.verbType===S.EXIT){r=this._activeKeys.indexOf(e.key);if(r>-1)this._activeKeys.splice(r,1);else if(n===undefined)return}if(e.verbType===S.ENTER){r=this._activeKeys.indexOf(e.key);if(r===-1)this._activeKeys.push(e.key);else if(n===undefined)return}i.push(e)},this),i.length>0&&(i=this._reorderEventList(i),this._doCallbacks("events",i,n),i.forEach(function(e){e.verbType===S.ENTER?this._doCallbacks("enter",e,n):e.verbType===S.EXIT&&this._doCallbacks("exit",e,n)},this))},A.prototype._doCallbacks=function(e,t,n){var r;this._callbacks[e].forEach(function(r){if(n===undefined){if(r["_immediatePending_"+e+this.ID])return}else{if(r!==n)return;n["_immediatePending_"+e+this.ID]=!1}try{r.call(r["_ctx_"+e+this.ID],t)}catch(i){console.log("Error in "+e+": "+r+": "+i)}},this)},A.prototype._reorderEventList=function(e){if(e.length<2)return e;var t,r,i=[],s={a:[],x:[],b:[],c:[],y:[],d:[]};return e.forEach(function(e){if(e.point!==t||e.dueTs!==r)i=i.concat(s.a).concat(s.x).concat(s.b).concat(s.c).concat(s.y).concat(s.d),s={a:[],x:[],b:[],c:[],y:[],d:[]},t=e.point,r=e.dueTs;if(e.pointType===n.PointType.SINGULAR)e.verbType===S.ENTER?s.b.push(e):s.c.push(e);else{var o=!1;e.pointType===n.PointType.LOW&&e.interval.lowInclude?o=!0:e.pointType===n.PointType.HIGH&&e.interval.highInclude&&(o=!0),e.verbType===S.ENTER?o?s.x.push(e):s.d.push(e):o?s.y.push(e):s.a.push(e)}},this),i.concat(s.a).concat(s.x).concat(s.b).concat(s.c).concat(s.y).concat(s.d)},A.prototype.on=function(e,t,n){if(!t||typeof t!="function")throw new C("Illegal handler");if(!this._callbacks.hasOwnProperty(e))throw new C("Unsupported event "+e);if(this._motion.readyState===this._motion.STATE.CLOSED)throw new C("Msv closed");var r=this._callbacks[e].indexOf(t);if(r===-1){t["_ctx_"+e+this.ID]=n||this,this._callbacks[e].push(t);if(e==="events"||e==="enter"){t["_immediatePending_"+e+this.ID]=!0;var i=this;setTimeout(function(){var n=i._initHandler(t);n||(t["_immediatePending_"+e+this.ID]=!1)},0)}}return this},A.prototype.off=function(e,t){if(this._callbacks[e]!==undefined){var n=this._callbacks[e].indexOf(t);n>-1&&this._callbacks[e].splice(n,1)}return this},A.prototype.request=function(){return new N(this)},A.prototype.addCue=function(e,t,n){return this.updateAll([{key:e,interval:t,data:n}])},A.prototype.removeCue=function(e,t){return this.updateAll([{key:e,interval:undefined,data:t}])},A.prototype.hasCue=function(e){return this._axis.hasKey(e)},A.prototype.keys=function(){return this._axis.keys()},A.prototype.getCue=function(e){if(this._axis.hasKey(e))return new L(e,this._axis.getIntervalByKey(e),this.getData(e))},A.prototype.getCues=function(){return this.keys().map(function(e){return this.getCue(e)},this)},A.prototype.isActive=function(e){return this._activeKeys.indexOf(e)>-1},A.prototype.getActiveKeys=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(t)},this),e},A.prototype.getActiveCues=function(){var e=[];return this._activeKeys.forEach(function(t){e.push(this.getCue(t))},this),e},A.prototype.getCuesByPoint=function(e){return this._axis.lookupByPoint(e).map(function(e){return this.getCue(e.key)},this)},A.prototype.getCuesByInterval=function(e){var t={};return this._axis.lookupByInterval(e).forEach(function(e){t[e.key]=e.interval}),Object.keys(t).map(function(e){return this.getCue(e)},this).filter(function(t){return e.coversInterval(t.interval)},this)},A.prototype.getCuesCoveredByInterval=function(e){return this.getCuesByInterval(e).filter(function(t){return e.overlapsInterval(t.interval)?!0:!1},this)},A.prototype.close=function(){this._motion.off("change",this._onMotionUpdate),this.to!==null&&(this.to.cancel(),this.to=null)};var O=function(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.uber=t.prototype,e.prototype.constructor=e};return{inherit:O,Interval:t,Sequencer:A,SequencerError:C}});